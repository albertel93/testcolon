<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Test de Colonias ‚Äî Paso a paso</title>
<style>
body{background:#0b0f14;color:#e7eef7;font-family:system-ui,Arial,sans-serif;margin:0}
.card{background:#121821;border:1px solid #202C3D;border-radius:14px;padding:20px;margin:20px auto;max-width:800px}
.btn{border:1px solid #2a3950;background:#1f2a3a;color:#e7eef7;padding:10px 16px;border-radius:10px;cursor:pointer}
.btn:hover{background:#243145}
.choice{border:1px dashed #2a3950;border-radius:12px;padding:18px;background:#121a2a;text-align:center;margin:10px}
.code{font-size:26px;font-weight:800;margin-bottom:8px}
.hidden{display:none}
.selected{outline:2px solid #7bdcff;box-shadow:0 0 0 6px rgba(123,220,255,.15)}
.final-card{border:1px solid #2a3950;border-radius:12px;padding:14px;margin:10px;background:#121a2a}
.winner{border-color:#ffd54a;box-shadow:0 0 0 3px rgba(255,213,74,.15)}
.second{border-color:#c7d1da;box-shadow:0 0 0 3px rgba(199,209,218,.15)}
.third{border-color:#d6a171;box-shadow:0 0 0 3px rgba(214,161,113,.15)}
.results-lines p{margin:.4rem 0}
.ctas{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
</style>
</head>
<body>

<div class="card" id="setup">
<h3>Inicio</h3>
<p>Colonias: 1, 2, 3, 5, 6, 7M, 7H, 8, 9</p>
<input id="subject" placeholder="Nombre del sujeto" style="width:100%;padding:8px;border-radius:8px;border:1px solid #243145;background:#111826;color:#fff">
<br><br><button class="btn" id="start">Empezar prueba</button>
</div>

<div class="card hidden" id="duel">
<h3 id="roundTitle"></h3>
<div id="pair" style="display:flex;justify-content:space-around;align-items:center;flex-wrap:wrap;"></div>
<button class="btn" id="next" disabled>Siguiente</button>
</div>

<div class="card hidden" id="final">
<h3>Final (elige 1¬∫ / 2¬∫ / 3¬∫)</h3>
<div id="finalists"></div>
<button class="btn hidden" id="showResults">Mostrar resultados</button>
</div>

<div class="card hidden" id="results">
<h3>Resultados</h3>
<div id="resultContent" class="results-lines"></div>
<div class="ctas">
  <button class="btn" id="export">Descargar CSV (este sujeto)</button>
  <button class="btn" id="email">Enviar por email</button>
</div>
</div>

<script>
const R1_PAIRS=[["1","2"],["3","5"],["6","7H"],["7M","8"]];
const R1_BYE="9";
const EMAIL_TO="albertprodlet@gmail.com";

let subject="";
let round=1,index=0,r1Winners=[],r2Pairs=[],r2Winners=[],finalists=[],finalRanks={};

const $=s=>document.querySelector(s);
function clear(e){e.innerHTML="";}
function duelCard(code,onPick){const d=document.createElement("div");d.className="choice";d.innerHTML=`<div class='code'>${code}</div>`;const b=document.createElement("button");b.className="btn";b.textContent="Elegir";b.onclick=()=>onPick(code,d);d.appendChild(b);return d;}
function showDuel(a,b,title){$("#roundTitle").textContent=title;const c=$("#pair");clear(c);const L=duelCard(a,select),R=duelCard(b,select);c.append(L,R);$("#next").disabled=true;$("#duel").classList.remove("hidden");}
function select(code,el){document.querySelectorAll(".choice").forEach(x=>x.classList.remove("selected"));el.classList.add("selected");$("#next").dataset.winner=code;$("#next").disabled=false;}

$("#start").onclick=()=>{subject=$("#subject").value.trim();if(!subject)return alert("Introduce un nombre");$("#setup").classList.add("hidden");round=1;index=0;r1Winners=[];r2Winners=[];showDuel(...R1_PAIRS[0],"Ronda 1");};

$("#next").onclick=()=>{
 const w=$("#next").dataset.winner;if(!w)return;
 if(round===1){r1Winners.push(w);index++;
  if(index<R1_PAIRS.length){showDuel(...R1_PAIRS[index],"Ronda 1");}
  else{r1Winners.push(R1_BYE);startRound2();}
 }else if(round===2){r2Winners.push(w);index++;
  if(index<r2Pairs.length){showDuel(...r2Pairs[index],"Ronda 2");}
  else{finalists=[...r2Winners,R1_BYE];startFinal();}
 }
};

function startRound2(){
 round=2;index=0;
 const arr=[...r1Winners];arr.pop();
 r2Pairs=[[arr[0],arr[1]],[arr[2],arr[3]]];
 showDuel(...r2Pairs[0],"Ronda 2");
}

function startFinal(){
 $("#duel").classList.add("hidden");
 $("#final").classList.remove("hidden");
 clear($("#finalists"));finalRanks={};
 finalists.forEach(c=>{
  const d=document.createElement("div");d.className="final-card";
  d.innerHTML=`<div class='code'>${c}</div>`;
  [1,2,3].forEach(r=>{const b=document.createElement("button");b.className="btn";b.textContent=r+"¬∫";b.onclick=()=>setRank(c,r);d.appendChild(b);});
  $("#finalists").appendChild(d);
 });
}
function setRank(c,r){for(const k in finalRanks)if(finalRanks[k]===r)delete finalRanks[k];finalRanks[c]=r;
document.querySelectorAll(".final-card").forEach(x=>x.classList.remove("winner","second","third"));
for(const [cc,rr] of Object.entries(finalRanks)){const el=[...document.querySelectorAll(".final-card")].find(x=>x.textContent.includes(cc));if(rr===1)el.classList.add("winner");if(rr===2)el.classList.add("second");if(rr===3)el.classList.add("third");}
if(Object.keys(finalRanks).length===3)$("#showResults").classList.remove("hidden");}

$("#showResults").onclick=()=>{
 $("#final").classList.add("hidden");
 $("#results").classList.remove("hidden");
 const arr=Object.entries(finalRanks).sort((a,b)=>a[1]-b[1]);
 const gold=arr[0][0], silver=arr[1][0], bronze=arr[2][0];
 const box=$("#resultContent"); clear(box);
 box.innerHTML = `<p><b>${subject}</b></p>
 <p>üèÜ 1¬™: ${gold}</p>
 <p>ü•à 2¬™: ${silver}</p>
 <p>ü•â 3¬™: ${bronze}</p>
 <p style="opacity:.75">Finalistas: ${finalists.join(", ")}</p>
 <p style="opacity:.6">R1 ganadoras: ${r1Winners.join(", ")}</p>`;

 // Wire export (single subject)
 $("#export").onclick = () => {
   const rows = [["timestamp","sujeto","1a","2a","3a","finalistas","r1_winners"]];
   rows.push([new Date().toISOString(), subject, gold, silver, bronze, finalists.join(" | "), r1Winners.join(" | ")]);
   download("resultado_"+subject.replace(/\s+/g,"_")+".csv", toCSV(rows));
 };

 // Wire email (mailto)
 $("#email").onclick = () => {
   const subjectLine = encodeURIComponent("Resultados test colonias ‚Äî " + subject);
   const body = [
     "Sujeto: " + subject,
     "1¬™: " + gold,
     "2¬™: " + silver,
     "3¬™: " + bronze,
     "Finalistas: " + finalists.join(", "),
     "R1 ganadoras: " + r1Winners.join(", ")
   ].join("\n");
   const href = "mailto:" + encodeURIComponent(EMAIL_TO) + "?subject=" + subjectLine + "&body=" + encodeURIComponent(body);
   const a = document.createElement("a");
   a.href = href;
   a.click();
 };
};

// Helpers CSV
function toCSV(rows){
  return rows.map(r => r.map(x => {
    const s = (x ?? "").toString();
    return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }).join(",")).join("\n");
}
function download(filename, text){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"text/csv;charset=utf-8;"}));
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
}
</script>
</body>
</html>
